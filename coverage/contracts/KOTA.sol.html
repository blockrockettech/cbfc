<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/KOTA.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> KOTA.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">98.33% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>59/60</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">57.69% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>15/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">95.24% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>20/21</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">98.53% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>67/68</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">50×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.4.24;
&nbsp;
import "./Strings.sol";
&nbsp;
import 'openzeppelin-solidity/contracts/ownership/Ownable.sol';
import 'openzeppelin-solidity/contracts/math/SafeMath.sol';
import 'openzeppelin-solidity/contracts/token/ERC721/ERC721Token.sol';
import 'openzeppelin-solidity/contracts/lifecycle/Pausable.sol';
import 'openzeppelin-solidity/contracts/access/rbac/RBAC.sol';
&nbsp;
/**
* @title KOTA aka KnownOrigin Trading Assets
*
* max 999 cards per box - if box interval is 1000000
* max 999 minted per card - if card set interval is 1000
*/
contract KOTA is ERC721Token, RBAC, Pausable {
  using SafeMath for uint256;
&nbsp;
  event CardMinted(address indexed _owner, uint256 indexed _tokenId, bytes32 _name, uint32 _mintTime);
  event CardSetSoldOut(uint256 indexed _cardNumber, uint32 _soldOutTime);
  event CardPackBought(address indexed _owner, uint32 _boughtTime);
  event CardPackRedeemed(address indexed _owner, uint32 _giftTime);
&nbsp;
  string internal tokenBaseURI = "https://ipfs.infura.io/ipfs/";
&nbsp;
  uint256 public totalCardsInCirculation = 0;
  uint256 public totalCardsInCirculationSold = 0;
  uint256 public totalWei = 0;
&nbsp;
  uint256 public defaultBoxNumber = 1000000;
&nbsp;
  uint256 internal randNonce = 0;
&nbsp;
  mapping(uint256 =&gt; mapping(address =&gt; uint)) internal boxNumberToAccountCredits;
&nbsp;
  struct Box {
    uint256 boxNumber;
    string title;
    string description;
    string boxURI;
    uint256 costOfPack;
    uint8 cardsPerPack;
  }
&nbsp;
  struct CardSet {
    uint256 boxNumber;
    uint256 cardNumber;
    uint256 totalSupply;
    uint256 minted;
    bytes32 cardName;
    string cardURI;
    address artist;
    uint8 artistShare;
  }
  mapping(uint256 =&gt; Box) public boxNumberToBox;
&nbsp;
  mapping(uint256 =&gt; CardSet) public boxCardNumberToCardSet;
&nbsp;
  mapping(uint256 =&gt; CardSet[]) internal boxNumberToCardSetCirculation;
  mapping(uint256 =&gt; uint256[]) internal boxNumberToCardNumbers;
&nbsp;
  mapping(uint256 =&gt; uint256) public boxNumberToCardsInCirculation;
  mapping(uint256 =&gt; uint256) public boxNumberToCardsInCirculationSold;
&nbsp;
  // allows KOTA to award cards stars
  mapping(uint256 =&gt; uint256) public tokenIdToStars;
&nbsp;
  uint256[] internal boxNumbers;
&nbsp;
  string constant ROLE_CREATOR = "ROLE_CREATOR";
  string constant ROLE_MINTER = "ROLE_MINTER";
&nbsp;
  constructor() public ERC721Token("KOTA", "KOTA") {
    addRole(msg.sender, ROLE_CREATOR);
    addRole(msg.sender, ROLE_MINTER);
  }
&nbsp;
  // can buy direct from contract if you send enough ether
<span class="fstat-no" title="function not covered" >  function() public payable </span>{
<span class="cstat-no" title="statement not covered" >    buyPack(defaultBoxNumber)</span>;
  }
&nbsp;
  function addBox(
    uint256 _boxNumber,
    string _title,
    string _description,
    string _boxUri,
    uint256 _costOfPack,
    uint8 _cardsPerPack
  ) public onlyRole(ROLE_CREATOR) {
    Box memory _newBox = Box(_boxNumber, _title, _description, _boxUri, _costOfPack, _cardsPerPack);
&nbsp;
    boxNumberToBox[_boxNumber] = _newBox;
    boxNumbers.push(_boxNumber);
  }
&nbsp;
  function addCardSet(
    uint256 _boxNumber,
    uint256 _cardNumber,
    uint256 _totalSupply,
    bytes32 _cardName,
    string _cardUri,
    address _artist,
    uint8 _artistShare
  ) public onlyRole(ROLE_CREATOR) {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(boxNumberToBox[_boxNumber].boxNumber &gt; 0, "Box should exist");
&nbsp;
    uint256 _boxCardNumber = _boxNumber.add(_cardNumber);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(boxCardNumberToCardSet[_boxCardNumber].cardNumber == 0, "Card Set should not exist");
&nbsp;
    // add new card set by boxCardNumber
    CardSet memory _newCardSet = CardSet(_boxNumber, _cardNumber, _totalSupply, 0, _cardName, _cardUri, _artist, _artistShare);
    boxCardNumberToCardSet[_boxCardNumber] = _newCardSet;
&nbsp;
    // add to box circulation
    boxNumberToCardSetCirculation[_boxNumber].push(_newCardSet); // FIXME - use flag to decide to add to circulation
    boxNumberToCardNumbers[_boxNumber].push(_cardNumber);
&nbsp;
    boxNumberToCardsInCirculation[_boxNumber] = boxNumberToCardsInCirculation[_boxNumber].add(_totalSupply);
    totalCardsInCirculation = totalCardsInCirculation.add(_totalSupply);
  }
&nbsp;
  /**
   * @dev mints a single card
   * @param _to who will get the card
   * @param _boxNumber box number of card to mint
   * @param _cardNumber card number of the card set to transfer
   */
  function mint(
    address _to,
    uint256 _boxNumber,
    uint256 _cardNumber
  ) public onlyRole(ROLE_MINTER) {
    uint256 _boxCardNumber = _boxNumber.add(_cardNumber);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(boxCardNumberToCardSet[_boxCardNumber].boxNumber &gt; 0, "Card set and Box must exist"); // ensure real card set
&nbsp;
    CardSet storage cardSet = boxCardNumberToCardSet[_boxCardNumber];
&nbsp;
    // don't transfer last card!
    // buyPack removes from circulation via index - we don't know index here...
    <span class="missing-if-branch" title="else path not taken" >E</span>require(cardSet.minted.add(1) &lt; cardSet.totalSupply, "Can't mint last card via mint method");
&nbsp;
    boxNumberToCardsInCirculationSold[_boxNumber] = boxNumberToCardsInCirculationSold[_boxNumber].add(1);
    totalCardsInCirculationSold = totalCardsInCirculationSold.add(1);
&nbsp;
    _mint(_to, cardSet);
  }
&nbsp;
  /**
   * @dev Buys a pack of cards
   */
  function buyPack(uint256 _boxNumber) public payable whenNotPaused {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(cardSetsInCirculation(_boxNumber) &gt; 0, "Card sets must exits for Box");
    <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.value &gt;= boxNumberToBox[_boxNumber].costOfPack, "Value must exceed the cost of the pack");
&nbsp;
    _randomPack(_boxNumber);
&nbsp;
    // reconcile payments
    owner.transfer(boxNumberToBox[_boxNumber].costOfPack);
    totalWei = totalWei.add(boxNumberToBox[_boxNumber].costOfPack);
&nbsp;
    // give back the change - if any
    msg.sender.transfer(msg.value - boxNumberToBox[_boxNumber].costOfPack);
    emit CardPackBought(msg.sender, uint32(now));
  }
&nbsp;
  /**
   * @dev Redeem a pack of cards (via a credit)
   */
  function redeemPack(uint256 _boxNumber) public whenNotPaused {
    require(boxNumberToAccountCredits[_boxNumber][msg.sender] &gt; 0);
&nbsp;
    // remove credit
    boxNumberToAccountCredits[_boxNumber][msg.sender] = boxNumberToAccountCredits[_boxNumber][msg.sender].sub(1);
&nbsp;
    _randomPack(_boxNumber);
&nbsp;
    emit CardPackRedeemed(msg.sender, uint32(now));
  }
&nbsp;
  /**
   * @dev Return owned tokens
   * @param _owner address to query
   */
  function tokensOf(address _owner) public view returns (uint256[] _tokenIds) {
    return ownedTokens[_owner];
  }
&nbsp;
  /**
   * @dev All box numbers
   */
  function allBoxNumbers() public view returns (uint256[] _boxNumbers) {
    return boxNumbers;
  }
&nbsp;
  /**
   * @dev number of card sets in circulation for a box
   * @param _boxNumber box number of card sets
   */
  function cardSetsInCirculation(uint256 _boxNumber) public view returns (uint256 _cardSetCirculationLength) {
    return boxNumberToCardSetCirculation[_boxNumber].length;
  }
&nbsp;
  /**
   * @dev card numbers for a box
   * @param _boxNumber box number of card sets
   */
  function cardNumbersOf(uint256 _boxNumber) public view returns (uint256[] _cardNumbersArray) {
    return boxNumberToCardNumbers[_boxNumber];
  }
&nbsp;
  /**
   * @dev checks for owned tokens
   * @param _owner address to query
   */
  function hasTokens(address _owner) public constant returns (bool) {
    return ownedTokens[_owner].length &gt; 0;
  }
&nbsp;
  /**
   * @dev Utility function to credit address with packs they can redeem
   * @dev Reverts if not called by owner
   * @param _boxNumber number of the box to credit
   * @param _recipient receiver of credit
   */
  function addCredit(uint256 _boxNumber, address _recipient) external onlyOwner {
    boxNumberToAccountCredits[_boxNumber][_recipient] = boxNumberToAccountCredits[_boxNumber][_recipient].add(1);
  }
&nbsp;
  /**
   * @dev Credits for account for box
   * @param _boxNumber number of the box to credit
   * @param _recipient receiver of credit
   */
  function creditsOf(uint256 _boxNumber, address _recipient) public view returns (uint256 _credits) {
    return boxNumberToAccountCredits[_boxNumber][_recipient];
  }
&nbsp;
  /**
   * @dev Get token URI fro the given token, useful for testing purposes
   * @param _tokenId the token ID
   * @return the token ID or only the base URI if not found
   */
  function tokenURI(uint256 _tokenId) public view returns (string) {
    return Strings.strConcat(tokenBaseURI, super.tokenURI(_tokenId));
  }
&nbsp;
  /**
   * @dev Allows management to update the base tokenURI path
   * @dev Reverts if not called by owner
   * @param _newBaseURI the new base URI to set
   */
  function setTokenBaseURI(string _newBaseURI) external onlyOwner {
    tokenBaseURI = _newBaseURI;
  }
&nbsp;
  /**
   * @dev Allows management to update the default box number
   * @dev Reverts if not called by owner
   * @param _defaultBoxNumber new default box number
   */
  function setDefaultBoxNumber(uint256 _defaultBoxNumber) external onlyOwner {
    defaultBoxNumber = _defaultBoxNumber;
  }
&nbsp;
  function _randomPack(uint256 _boxNumber) internal {
    // thanks CryptoStrikers!
    <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == tx.origin, "Don't allow contracts to buy");
&nbsp;
    for (uint i = 0; i &lt; boxNumberToBox[_boxNumber].cardsPerPack; i++) {
      uint _index = _randomCardSetIndex(_boxNumber, i + 1);
      CardSet storage pickedSet = boxNumberToCardSetCirculation[_boxNumber][_index];
&nbsp;
      _mint(msg.sender, pickedSet);
&nbsp;
      // remove from circulation if minted == totalSupply
      if (pickedSet.minted == pickedSet.totalSupply) {
        _removeCardSetAtIndex(_boxNumber, _index);
        emit CardSetSoldOut(pickedSet.cardNumber, uint32(now));
      }
    }
&nbsp;
    boxNumberToCardsInCirculationSold[_boxNumber] = boxNumberToCardsInCirculationSold[_boxNumber].add(boxNumberToBox[_boxNumber].cardsPerPack);
    totalCardsInCirculationSold = totalCardsInCirculationSold.add(boxNumberToBox[_boxNumber].cardsPerPack);
  }
&nbsp;
  function _randomCardSetIndex(uint256 _boxNumber, uint _index) internal returns (uint) {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_index &gt; 0);
&nbsp;
    randNonce = randNonce.add(1);
    bytes memory packed = abi.encodePacked(blockhash(block.number - _index), msg.sender, randNonce);
    return uint256(keccak256(packed)) % cardSetsInCirculation(_boxNumber);
  }
&nbsp;
  function _mint(address _to, CardSet storage _cardSet) internal {
    // ensure valid card set
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_cardSet.totalSupply &gt; 0, "Card set supply must be greater than zero");
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_cardSet.minted &lt;= _cardSet.totalSupply, "Card set must have cards left");
&nbsp;
    _cardSet.minted = _cardSet.minted.add(1);
    uint256 cardSerialNumber = _cardSet.boxNumber.add(_cardSet.cardNumber).add(_cardSet.minted);
&nbsp;
    super._mint(_to, cardSerialNumber);
    super._setTokenURI(cardSerialNumber, _cardSet.cardURI);
&nbsp;
    emit CardMinted(_to, cardSerialNumber, _cardSet.cardName, uint32(now));
  }
&nbsp;
  function _removeCardSetAtIndex(uint256 _boxNumber, uint256 _index) internal {
    uint lastIndex = cardSetsInCirculation(_boxNumber) - 1;
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_index &lt;= lastIndex);
&nbsp;
    boxNumberToCardSetCirculation[_boxNumber][_index] = boxNumberToCardSetCirculation[_boxNumber][lastIndex];
    boxNumberToCardSetCirculation[_boxNumber].length--;
  }
&nbsp;
  // FIXME - ability to remove cardset by creator role
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Sep 20 2018 16:06:25 GMT+0100 (BST)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
